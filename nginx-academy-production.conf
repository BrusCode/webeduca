server {
	listen 80 default_server;
	listen [::]:80 default_server;

	root {{ document_root }};

	index index.php index.html;

	server_name _;

	# ========================================
	# CONFIGURAÇÕES PARA UPLOADS DE ATÉ 2GB
	# ========================================
	
	# Tamanho máximo do body da requisição (2GB + margem)
	client_max_body_size 2148M;
	
	# Timeout para receber o body do cliente (30 minutos)
	client_body_timeout 1800s;
	
	# Timeout para enviar resposta ao cliente (30 minutos)
	send_timeout 1800s;
	
	# Buffer para o body da requisição (importante para uploads grandes)
	client_body_buffer_size 128k;
	
	# Diretório temporário para armazenar uploads (use SSD se possível)
	client_body_temp_path /tmp/nginx_client_body;

	# ========================================
	# CONFIGURAÇÕES DE PERFORMANCE
	# ========================================
	
	# Habilitar compressão gzip
	gzip on;
	gzip_vary on;
	gzip_proxied any;
	gzip_comp_level 6;
	gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
	gzip_disable "msie6";
	
	# Cache de arquivos estáticos
	location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
		expires 30d;
		add_header Cache-Control "public, immutable";
		access_log off;
	}

	# ========================================
	# CONFIGURAÇÕES DE SEGURANÇA
	# ========================================
	
	# Ocultar versão do Nginx
	server_tokens off;
	
	# Headers de segurança
	add_header X-Frame-Options "SAMEORIGIN" always;
	add_header X-Content-Type-Options "nosniff" always;
	add_header X-XSS-Protection "1; mode=block" always;
	add_header Referrer-Policy "no-referrer-when-downgrade" always;
	
	# Bloquear acesso a arquivos sensíveis
	location ~ /\.(?!well-known).* {
		deny all;
		access_log off;
		log_not_found off;
	}
	
	# Bloquear acesso a arquivos de configuração
	location ~ ^/(application|system)/ {
		deny all;
		return 404;
	}

	# ========================================
	# ROTEAMENTO PRINCIPAL
	# ========================================
	
	location / {
		try_files $uri $uri/ /index.php?$query_string;
	}

	# ========================================
	# PROCESSAMENTO PHP
	# ========================================
	
	location ~ \.php$ {
		include snippets/fastcgi-php.conf;
		fastcgi_pass {{ fpm_socket }};
		
		# Forçar HTTPS nos parâmetros do FastCGI
		fastcgi_param HTTPS on;
		
		# Timeouts do FastCGI (30 minutos para uploads grandes)
		fastcgi_connect_timeout 1800s;
		fastcgi_send_timeout 1800s;
		fastcgi_read_timeout 1800s;
		
		# Buffers do FastCGI (otimizado para respostas grandes)
		fastcgi_buffer_size 128k;
		fastcgi_buffers 256 16k;
		fastcgi_busy_buffers_size 256k;
		fastcgi_temp_file_write_size 256k;
		
		# Interceptar erros do FastCGI
		fastcgi_intercept_errors off;
	}
	
	# ========================================
	# PROTEÇÃO CONTRA BOTS E SCANNERS
	# ========================================
	
	# Bloquear acesso a arquivos de backup
	location ~ \.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)$ {
		deny all;
		access_log off;
		log_not_found off;
	}
	
	# Bloquear acesso ao composer.json
	location ~ ^/(composer\.json|composer\.lock|package\.json|package-lock\.json)$ {
		deny all;
		access_log off;
		log_not_found off;
	}
}

